import React, { useState, useEffect } from 'react';
import { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { Leaf, Droplets, TrendingUp, Activity, ShoppingCart, BarChart3, User, LogOut, Plus, Search, Filter, Edit, Trash2, Bell, Settings, Eye } from 'lucide-react';

// Mock Data Generator
const generateMockData = () => {
  const users = [
    {
      id: '1',
      name: 'Ahmad Hidayat',
      email: 'ahmad@energrow.com',
      password: 'password123',
      userType: 'producer',
      location: 'Surabaya',
      phone: '081234567890'
    }
  ];

  const bioreactors = [
    {
      id: 'br1',
      userId: '1',
      name: 'Bioreaktor Alpha',
      capacity: 1000,
      status: 'active',
      installationDate: '2024-01-15',
      location: 'Surabaya Timur'
    },
    {
      id: 'br2',
      userId: '1',
      name: 'Bioreaktor Beta',
      capacity: 1500,
      status: 'active',
      installationDate: '2024-03-20',
      location: 'Surabaya Barat'
    }
  ];

  const sensorData = bioreactors.map(br => ({
    bioreactorId: br.id,
    temperature: Math.random() * 10 + 35,
    phLevel: Math.random() * 1 + 6.5,
    gasProduction: Math.random() * 50 + 100,
    pressure: Math.random() * 0.5 + 1.0,
    feedstockLevel: Math.random() * 30 + 60,
    timestamp: new Date().toISOString()
  }));

  const listings = [
    {
      id: 'l1',
      sellerId: '1',
      sellerName: 'Ahmad Hidayat',
      sellerLocation: 'Surabaya',
      productType: 'biogas',
      quantity: 500,
      pricePerUnit: 4500,
      status: 'available',
      description: 'Biogas berkualitas tinggi dari limbah organik'
    },
    {
      id: 'l2',
      sellerId: '1',
      sellerName: 'Ahmad Hidayat',
      sellerLocation: 'Surabaya',
      productType: 'fertilizer',
      quantity: 200,
      pricePerUnit: 15000,
      status: 'available',
      description: 'Pupuk organik cair kaya nutrisi'
    }
  ];

  return { users, bioreactors, sensorData, listings };
};

// Initialize localStorage
const initializeData = () => {
  if (!localStorage.getItem('energrow_users')) {
    const { users, bioreactors, sensorData, listings } = generateMockData();
    localStorage.setItem('energrow_users', JSON.stringify(users));
    localStorage.setItem('energrow_bioreactors', JSON.stringify(bioreactors));
    localStorage.setItem('energrow_sensors', JSON.stringify(sensorData));
    localStorage.setItem('energrow_listings', JSON.stringify(listings));
  }
};

// Main App Component
export default function EnerGrowApp() {
  const [currentUser, setCurrentUser] = useState(null);
  const [currentPage, setCurrentPage] = useState('login');
  const [bioreactors, setBioreactors] = useState([]);
  const [sensorData, setSensorData] = useState([]);
  const [listings, setListings] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [modalType, setModalType] = useState('');
  const [selectedBioreactor, setSelectedBioreactor] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterType, setFilterType] = useState('all');

  useEffect(() => {
    initializeData();
    const user = localStorage.getItem('energrow_current_user');
    if (user) {
      setCurrentUser(JSON.parse(user));
      setCurrentPage('dashboard');
      loadData();
    }
  }, []);

  const loadData = () => {
    setBioreactors(JSON.parse(localStorage.getItem('energrow_bioreactors') || '[]'));
    setSensorData(JSON.parse(localStorage.getItem('energrow_sensors') || '[]'));
    setListings(JSON.parse(localStorage.getItem('energrow_listings') || '[]'));
  };

  // Auth Functions
  const handleLogin = (email, password) => {
    const users = JSON.parse(localStorage.getItem('energrow_users') || '[]');
    const user = users.find(u => u.email === email && u.password === password);
    if (user) {
      setCurrentUser(user);
      localStorage.setItem('energrow_current_user', JSON.stringify(user));
      setCurrentPage('dashboard');
      loadData();
      return true;
    }
    return false;
  };

  const handleRegister = (userData) => {
    const users = JSON.parse(localStorage.getItem('energrow_users') || '[]');
    const newUser = { ...userData, id: Date.now().toString() };
    users.push(newUser);
    localStorage.setItem('energrow_users', JSON.stringify(users));
    handleLogin(userData.email, userData.password);
  };

  const handleLogout = () => {
    setCurrentUser(null);
    localStorage.removeItem('energrow_current_user');
    setCurrentPage('login');
  };

  // Bioreactor Functions
  const addBioreactor = (data) => {
    const newBr = {
      ...data,
      id: 'br' + Date.now(),
      userId: currentUser.id,
      status: 'active',
      installationDate: new Date().toISOString().split('T')[0]
    };
    const updated = [...bioreactors, newBr];
    setBioreactors(updated);
    localStorage.setItem('energrow_bioreactors', JSON.stringify(updated));
    
    // Add initial sensor data
    const newSensor = {
      bioreactorId: newBr.id,
      temperature: 40,
      phLevel: 7.0,
      gasProduction: 120,
      pressure: 1.2,
      feedstockLevel: 80,
      timestamp: new Date().toISOString()
    };
    const updatedSensors = [...sensorData, newSensor];
    setSensorData(updatedSensors);
    localStorage.setItem('energrow_sensors', JSON.stringify(updatedSensors));
    setShowModal(false);
  };

  // Marketplace Functions
  const addListing = (data) => {
    const newListing = {
      ...data,
      id: 'l' + Date.now(),
      sellerId: currentUser.id,
      sellerName: currentUser.name,
      sellerLocation: currentUser.location,
      status: 'available'
    };
    const updated = [...listings, newListing];
    setListings(updated);
    localStorage.setItem('energrow_listings', JSON.stringify(updated));
    setShowModal(false);
  };

  const purchaseListing = (listingId) => {
    const updated = listings.map(l => 
      l.id === listingId ? { ...l, status: 'sold' } : l
    );
    setListings(updated);
    localStorage.setItem('energrow_listings', JSON.stringify(updated));
    alert('Pembelian berhasil! Penjual akan menghubungi Anda.');
  };

  // Calculate Statistics
  const stats = {
    totalGas: sensorData.reduce((sum, s) => sum + s.gasProduction, 0).toFixed(0),
    co2Reduced: (sensorData.reduce((sum, s) => sum + s.gasProduction, 0) * 2.3).toFixed(0),
    efficiency: bioreactors.length > 0 ? 87 : 0,
    activeBioreactors: bioreactors.filter(b => b.status === 'active').length
  };

  // Render Functions
  if (!currentUser) {
    return <AuthPage onLogin={handleLogin} onRegister={handleRegister} />;
  }

  return (
    <div style={{ minHeight: '100vh', backgroundColor: '#f5f5f5', fontFamily: 'system-ui, -apple-system, sans-serif' }}>
      {/* Header */}
      <header style={{ backgroundColor: '#2E7D32', color: 'white', padding: '1rem 2rem', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', maxWidth: '1400px', margin: '0 auto' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: '1.5rem', fontWeight: 'bold' }}>
            <Leaf size={32} />
            EnerGrow
          </div>
          <nav style={{ display: 'flex', gap: '2rem' }}>
            <button onClick={() => setCurrentPage('dashboard')} style={{ background: 'none', border: 'none', color: 'white', cursor: 'pointer', fontSize: '1rem', padding: '0.5rem 1rem', borderRadius: '4px', backgroundColor: currentPage === 'dashboard' ? 'rgba(255,255,255,0.2)' : 'transparent' }}>
              Dashboard
            </button>
            <button onClick={() => setCurrentPage('marketplace')} style={{ background: 'none', border: 'none', color: 'white', cursor: 'pointer', fontSize: '1rem', padding: '0.5rem 1rem', borderRadius: '4px', backgroundColor: currentPage === 'marketplace' ? 'rgba(255,255,255,0.2)' : 'transparent' }}>
              Marketplace
            </button>
            <button onClick={() => setCurrentPage('analytics')} style={{ background: 'none', border: 'none', color: 'white', cursor: 'pointer', fontSize: '1rem', padding: '0.5rem 1rem', borderRadius: '4px', backgroundColor: currentPage === 'analytics' ? 'rgba(255,255,255,0.2)' : 'transparent' }}>
              Analytics
            </button>
            <button onClick={() => setCurrentPage('profile')} style={{ background: 'none', border: 'none', color: 'white', cursor: 'pointer', fontSize: '1rem', padding: '0.5rem 1rem', borderRadius: '4px', backgroundColor: currentPage === 'profile' ? 'rgba(255,255,255,0.2)' : 'transparent' }}>
              Profile
            </button>
            <button onClick={handleLogout} style={{ background: 'none', border: 'none', color: 'white', cursor: 'pointer', fontSize: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
              <LogOut size={18} /> Logout
            </button>
          </nav>
        </div>
      </header>

      {/* Main Content */}
      <main style={{ maxWidth: '1400px', margin: '0 auto', padding: '2rem' }}>
        {currentPage === 'dashboard' && (
          <DashboardPage 
            stats={stats}
            bioreactors={bioreactors}
            sensorData={sensorData}
            onAddBioreactor={() => { setModalType('addBioreactor'); setShowModal(true); }}
            onViewDetails={(br) => { setSelectedBioreactor(br); setModalType('viewBioreactor'); setShowModal(true); }}
          />
        )}
        {currentPage === 'marketplace' && (
          <MarketplacePage 
            listings={listings.filter(l => l.status === 'available')}
            searchTerm={searchTerm}
            setSearchTerm={setSearchTerm}
            filterType={filterType}
            setFilterType={setFilterType}
            onAddListing={() => { setModalType('addListing'); setShowModal(true); }}
            onPurchase={purchaseListing}
            currentUserId={currentUser.id}
          />
        )}
        {currentPage === 'analytics' && (
          <AnalyticsPage bioreactors={bioreactors} sensorData={sensorData} />
        )}
        {currentPage === 'profile' && (
          <ProfilePage user={currentUser} />
        )}
      </main>

      {/* Modals */}
      {showModal && modalType === 'addBioreactor' && (
        <AddBioreactorModal onClose={() => setShowModal(false)} onAdd={addBioreactor} />
      )}
      {showModal && modalType === 'addListing' && (
        <AddListingModal onClose={() => setShowModal(false)} onAdd={addListing} />
      )}
      {showModal && modalType === 'viewBioreactor' && selectedBioreactor && (
        <BioreactorDetailModal 
          bioreactor={selectedBioreactor} 
          sensorData={sensorData.find(s => s.bioreactorId === selectedBioreactor.id)}
          onClose={() => { setShowModal(false); setSelectedBioreactor(null); }}
        />
      )}
    </div>
  );
}

// Auth Page Component
function AuthPage({ onLogin, onRegister }) {
  const [isLogin, setIsLogin] = useState(true);
  const [formData, setFormData] = useState({ email: '', password: '', name: '', userType: 'producer', location: '', phone: '' });
  const [error, setError] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    setError('');
    
    if (isLogin) {
      if (!onLogin(formData.email, formData.password)) {
        setError('Email atau password salah');
      }
    } else {
      if (!formData.name || !formData.email || !formData.password || !formData.location || !formData.phone) {
        setError('Semua field harus diisi');
        return;
      }
      onRegister(formData);
    }
  };

  return (
    <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'linear-gradient(135deg, #2E7D32 0%, #1976D2 100%)' }}>
      <div style={{ backgroundColor: 'white', padding: '3rem', borderRadius: '12px', boxShadow: '0 20px 60px rgba(0,0,0,0.3)', width: '100%', maxWidth: '450px' }}>
        <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
          <Leaf size={48} color="#2E7D32" style={{ margin: '0 auto' }} />
          <h1 style={{ fontSize: '2rem', color: '#2E7D32', marginTop: '1rem' }}>EnerGrow</h1>
          <p style={{ color: '#666', marginTop: '0.5rem' }}>Bioreaktor & Marketplace Energi Terbarukan</p>
        </div>

        <div style={{ display: 'flex', marginBottom: '2rem', borderRadius: '8px', backgroundColor: '#f5f5f5', padding: '4px' }}>
          <button 
            onClick={() => setIsLogin(true)}
            style={{ flex: 1, padding: '0.75rem', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: '600', backgroundColor: isLogin ? '#2E7D32' : 'transparent', color: isLogin ? 'white' : '#666', transition: 'all 0.3s' }}
          >
            Login
          </button>
          <button 
            onClick={() => setIsLogin(false)}
            style={{ flex: 1, padding: '0.75rem', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: '600', backgroundColor: !isLogin ? '#2E7D32' : 'transparent', color: !isLogin ? 'white' : '#666', transition: 'all 0.3s' }}
          >
            Register
          </button>
        </div>

        <form onSubmit={handleSubmit}>
          {!isLogin && (
            <>
              <input
                type="text"
                placeholder="Nama Lengkap"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                style={{ width: '100%', padding: '0.875rem', marginBottom: '1rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', boxSizing: 'border-box' }}
              />
              <select
                value={formData.userType}
                onChange={(e) => setFormData({ ...formData, userType: e.target.value })}
                style={{ width: '100%', padding: '0.875rem', marginBottom: '1rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', boxSizing: 'border-box' }}
              >
                <option value="producer">Producer</option>
                <option value="consumer">Consumer</option>
                <option value="both">Both</option>
              </select>
              <input
                type="text"
                placeholder="Lokasi"
                value={formData.location}
                onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                style={{ width: '100%', padding: '0.875rem', marginBottom: '1rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', boxSizing: 'border-box' }}
              />
              <input
                type="tel"
                placeholder="Nomor Telepon"
                value={formData.phone}
                onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                style={{ width: '100%', padding: '0.875rem', marginBottom: '1rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', boxSizing: 'border-box' }}
              />
            </>
          )}
          <input
            type="email"
            placeholder="Email"
            value={formData.email}
            onChange={(e) => setFormData({ ...formData, email: e.target.value })}
            style={{ width: '100%', padding: '0.875rem', marginBottom: '1rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', boxSizing: 'border-box' }}
            required
          />
          <input
            type="password"
            placeholder="Password"
            value={formData.password}
            onChange={(e) => setFormData({ ...formData, password: e.target.value })}
            style={{ width: '100%', padding: '0.875rem', marginBottom: '1rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', boxSizing: 'border-box' }}
            required
          />
          {error && <p style={{ color: '#d32f2f', marginBottom: '1rem', fontSize: '0.875rem' }}>{error}</p>}
          <button 
            type="submit"
            style={{ width: '100%', padding: '1rem', backgroundColor: '#2E7D32', color: 'white', border: 'none', borderRadius: '8px', fontSize: '1rem', fontWeight: '600', cursor: 'pointer', transition: 'background-color 0.3s' }}
          >
            {isLogin ? 'Login' : 'Register'}
          </button>
        </form>

        {isLogin && (
          <p style={{ marginTop: '1.5rem', textAlign: 'center', color: '#666', fontSize: '0.875rem' }}>
            Demo: ahmad@energrow.com / password123
          </p>
        )}
      </div>
    </div>
  );
}

// Dashboard Page Component
function DashboardPage({ stats, bioreactors, sensorData, onAddBioreactor, onViewDetails }) {
  return (
    <div>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
        <h2 style={{ fontSize: '2rem', color: '#212121' }}>Dashboard</h2>
        <button 
          onClick={onAddBioreactor}
          style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', padding: '0.75rem 1.5rem', backgroundColor: '#2E7D32', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '1rem', fontWeight: '600' }}
        >
          <Plus size={20} /> Tambah Bioreaktor
        </button>
      </div>

      {/* Stats Cards */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1.5rem', marginBottom: '2rem' }}>
        <StatCard icon={<Droplets size={32} />} title="Total Gas Produksi" value={`${stats.totalGas} m¬≥`} color="#1976D2" />
        <StatCard icon={<Leaf size={32} />} title="CO‚ÇÇ Dikurangi" value={`${stats.co2Reduced} kg`} color="#2E7D32" />
        <StatCard icon={<TrendingUp size={32} />} title="Efisiensi Rata-rata" value={`${stats.efficiency}%`} color="#F57C00" />
        <StatCard icon={<Activity size={32} />} title="Bioreaktor Aktif" value={stats.activeBioreactors} color="#7B1FA2" />
      </div>

      {/* Bioreactors List */}
      <h3 style={{ fontSize: '1.5rem', marginBottom: '1.5rem', color: '#212121' }}>Bioreaktor Saya</h3>
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: '1.5rem' }}>
        {bioreactors.map(br => {
          const sensor = sensorData.find(s => s.bioreactorId === br.id);
          return (
            <BioreactorCard 
              key={br.id} 
              bioreactor={br} 
              sensorData={sensor}
              onViewDetails={() => onViewDetails(br)}
            />
          );
        })}
        {bioreactors.length === 0 && (
          <div style={{ gridColumn: '1 / -1', textAlign: 'center', padding: '3rem', backgroundColor: 'white', borderRadius: '12px' }}>
            <p style={{ color: '#666', fontSize: '1.125rem' }}>Belum ada bioreaktor. Tambahkan bioreaktor pertama Anda!</p>
          </div>
        )}
      </div>
    </div>
  );
}

// Marketplace Page Component
function MarketplacePage({ listings, searchTerm, setSearchTerm, filterType, setFilterType, onAddListing, onPurchase, currentUserId }) {
  const filteredListings = listings.filter(l => {
    const matchesSearch = l.sellerName.toLowerCase().includes(searchTerm.toLowerCase()) || 
                         l.sellerLocation.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesFilter = filterType === 'all' || l.productType === filterType;
    return matchesSearch && matchesFilter;
  });

  return (
    <div>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
        <h2 style={{ fontSize: '2rem', color: '#212121' }}>Marketplace</h2>
        <button 
          onClick={onAddListing}
          style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', padding: '0.75rem 1.5rem', backgroundColor: '#1976D2', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontSize: '1rem', fontWeight: '600' }}
        >
          <Plus size={20} /> Tambah Listing
        </button>
      </div>

      {/* Search and Filter */}
      <div style={{ display: 'flex', gap: '1rem', marginBottom: '2rem', flexWrap: 'wrap' }}>
        <div style={{ flex: '1', minWidth: '250px', position: 'relative' }}>
          <Search size={20} style={{ position: 'absolute', left: '1rem', top: '50%', transform: 'translateY(-50%)', color: '#666' }} />
          <input
            type="text"
            placeholder="Cari penjual atau lokasi..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            style={{ width: '100%', padding: '0.875rem 1rem 0.875rem 3rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', boxSizing: 'border-box' }}
          />
        </div>
        <select
          value={filterType}
          onChange={(e) => setFilterType(e.target.value)}
          style={{ padding: '0.875rem 1rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', cursor: 'pointer' }}
        >
          <option value="all">Semua Produk</option>
          <option value="biogas">Biogas</option>
          <option value="fertilizer">Pupuk</option>
        </select>
      </div>

      {/* Listings Grid */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: '1.5rem' }}>
        {filteredListings.map(listing => (
          <ListingCard 
            key={listing.id} 
            listing={listing}
            onPurchase={() => onPurchase(listing.id)}
            isOwnListing={listing.sellerId === currentUserId}
          />
        ))}
        {filteredListings.length === 0 && (
          <div style={{ gridColumn: '1 / -1', textAlign: 'center', padding: '3rem', backgroundColor: 'white', borderRadius: '12px' }}>
            <p style={{ color: '#666', fontSize: '1.125rem' }}>Tidak ada listing yang sesuai dengan pencarian Anda.</p>
          </div>
        )}
      </div>
    </div>
  );
}

// Analytics Page Component
function AnalyticsPage({ bioreactors, sensorData }) {
  const chartData = bioreactors.map(br => {
    const sensor = sensorData.find(s => s.bioreactorId === br.id);
    return {
      name: br.name,
      production: sensor ? sensor.gasProduction : 0,
      efficiency: Math.random() * 20 + 75
    };
  });

  const monthlyData = [
    { month: 'Jan', gas: 850, revenue: 3825 },
    { month: 'Feb', gas: 920, revenue: 4140 },
    { month: 'Mar', gas: 1050, revenue: 4725 },
    { month: 'Apr', gas: 1100, revenue: 4950 },
    { month: 'Mei', gas: 1250, revenue: 5625 },
    { month: 'Jun', gas: 1180, revenue: 5310 }
  ];

  return (
    <div>
      <h2 style={{ fontSize: '2rem', color: '#212121', marginBottom: '2rem' }}>Analytics & Reporting</h2>

      <div style={{ display: 'grid', gap: '2rem' }}>
        {/* Gas Production Chart */}
        <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.1)' }}>
          <h3 style={{ marginBottom: '1.5rem', color: '#212121' }}>Produksi Gas per Bioreaktor</h3>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={chartData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="name" />
              <YAxis />
              <Tooltip />
              <Legend />
              <Bar dataKey="production" fill="#2E7D32" name="Gas (m¬≥)" />
            </BarChart>
          </ResponsiveContainer>
        </div>

        {/* Monthly Trends */}
        <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.1)' }}>
          <h3 style={{ marginBottom: '1.5rem', color: '#212121' }}>Tren Bulanan</h3>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={monthlyData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="month" />
              <YAxis yAxisId="left" />
              <YAxis yAxisId="right" orientation="right" />
              <Tooltip />
              <Legend />
              <Line yAxisId="left" type="monotone" dataKey="gas" stroke="#2E7D32" strokeWidth={2} name="Gas (m¬≥)" />
              <Line yAxisId="right" type="monotone" dataKey="revenue" stroke="#1976D2" strokeWidth={2} name="Revenue (Rp ribuan)" />
            </LineChart>
          </ResponsiveContainer>
        </div>

        {/* Environmental Impact */}
        <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.1)' }}>
          <h3 style={{ marginBottom: '1.5rem', color: '#212121' }}>Dampak Lingkungan</h3>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1.5rem' }}>
            <div style={{ textAlign: 'center', padding: '1.5rem', backgroundColor: '#E8F5E9', borderRadius: '8px' }}>
              <Leaf size={40} color="#2E7D32" style={{ margin: '0 auto 0.5rem' }} />
              <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#2E7D32', marginBottom: '0.25rem' }}>6,850</p>
              <p style={{ color: '#666' }}>kg CO‚ÇÇ Dikurangi</p>
            </div>
            <div style={{ textAlign: 'center', padding: '1.5rem', backgroundColor: '#E3F2FD', borderRadius: '8px' }}>
              <Droplets size={40} color="#1976D2" style={{ margin: '0 auto 0.5rem' }} />
              <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#1976D2', marginBottom: '0.25rem' }}>7,350</p>
              <p style={{ color: '#666' }}>m¬≥ Gas Diproduksi</p>
            </div>
            <div style={{ textAlign: 'center', padding: '1.5rem', backgroundColor: '#FFF3E0', borderRadius: '8px' }}>
              <TrendingUp size={40} color="#F57C00" style={{ margin: '0 auto 0.5rem' }} />
              <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#F57C00', marginBottom: '0.25rem' }}>32</p>
              <p style={{ color: '#666' }}>Ton Limbah Diproses</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Profile Page Component
function ProfilePage({ user }) {
  return (
    <div>
      <h2 style={{ fontSize: '2rem', color: '#212121', marginBottom: '2rem' }}>Profile & Settings</h2>
      
      <div style={{ display: 'grid', gap: '2rem', maxWidth: '800px' }}>
        {/* User Info */}
        <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.1)' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '2rem' }}>
            <div style={{ width: '80px', height: '80px', borderRadius: '50%', backgroundColor: '#2E7D32', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontSize: '2rem', fontWeight: 'bold' }}>
              {user.name.charAt(0)}
            </div>
            <div>
              <h3 style={{ fontSize: '1.5rem', marginBottom: '0.25rem' }}>{user.name}</h3>
              <p style={{ color: '#666' }}>{user.email}</p>
            </div>
          </div>
          
          <div style={{ display: 'grid', gap: '1rem' }}>
            <div>
              <label style={{ display: 'block', color: '#666', marginBottom: '0.5rem', fontSize: '0.875rem' }}>Tipe User</label>
              <p style={{ fontSize: '1rem', color: '#212121', textTransform: 'capitalize' }}>{user.userType}</p>
            </div>
            <div>
              <label style={{ display: 'block', color: '#666', marginBottom: '0.5rem', fontSize: '0.875rem' }}>Lokasi</label>
              <p style={{ fontSize: '1rem', color: '#212121' }}>{user.location}</p>
            </div>
            <div>
              <label style={{ display: 'block', color: '#666', marginBottom: '0.5rem', fontSize: '0.875rem' }}>Telepon</label>
              <p style={{ fontSize: '1rem', color: '#212121' }}>{user.phone}</p>
            </div>
          </div>
        </div>

        {/* Settings */}
        <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.1)' }}>
          <h3 style={{ fontSize: '1.25rem', marginBottom: '1.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
            <Settings size={24} /> Pengaturan
          </h3>
          
          <div style={{ display: 'grid', gap: '1rem' }}>
            <label style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', cursor: 'pointer' }}>
              <input type="checkbox" defaultChecked style={{ width: '18px', height: '18px' }} />
              <span>Notifikasi Email</span>
            </label>
            <label style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', cursor: 'pointer' }}>
              <input type="checkbox" defaultChecked style={{ width: '18px', height: '18px' }} />
              <span>Notifikasi Sensor</span>
            </label>
            <label style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', cursor: 'pointer' }}>
              <input type="checkbox" style={{ width: '18px', height: '18px' }} />
              <span>Notifikasi Marketplace</span>
            </label>
          </div>
        </div>
      </div>
    </div>
  );
}

// Stat Card Component
function StatCard({ icon, title, value, color }) {
  return (
    <div style={{ backgroundColor: 'white', padding: '1.5rem', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.1)', display: 'flex', alignItems: 'center', gap: '1rem' }}>
      <div style={{ padding: '1rem', borderRadius: '12px', backgroundColor: color + '15', color: color }}>
        {icon}
      </div>
      <div>
        <p style={{ color: '#666', fontSize: '0.875rem', marginBottom: '0.25rem' }}>{title}</p>
        <p style={{ fontSize: '1.75rem', fontWeight: 'bold', color: '#212121' }}>{value}</p>
      </div>
    </div>
  );
}

// Bioreactor Card Component
function BioreactorCard({ bioreactor, sensorData, onViewDetails }) {
  return (
    <div style={{ backgroundColor: 'white', padding: '1.5rem', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.1)' }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '1rem' }}>
        <div>
          <h4 style={{ fontSize: '1.25rem', marginBottom: '0.25rem' }}>{bioreactor.name}</h4>
          <p style={{ color: '#666', fontSize: '0.875rem' }}>{bioreactor.location}</p>
        </div>
        <span style={{ 
          padding: '0.375rem 0.75rem', 
          borderRadius: '20px', 
          fontSize: '0.75rem', 
          fontWeight: '600',
          backgroundColor: bioreactor.status === 'active' ? '#E8F5E9' : '#FFEBEE',
          color: bioreactor.status === 'active' ? '#2E7D32' : '#C62828'
        }}>
          {bioreactor.status === 'active' ? 'Aktif' : 'Tidak Aktif'}
        </span>
      </div>

      {sensorData && (
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
          <div>
            <p style={{ color: '#666', fontSize: '0.75rem', marginBottom: '0.25rem' }}>Temperature</p>
            <p style={{ fontSize: '1.125rem', fontWeight: '600' }}>{sensorData.temperature.toFixed(1)}¬∞C</p>
          </div>
          <div>
            <p style={{ color: '#666', fontSize: '0.75rem', marginBottom: '0.25rem' }}>pH Level</p>
            <p style={{ fontSize: '1.125rem', fontWeight: '600' }}>{sensorData.phLevel.toFixed(1)}</p>
          </div>
          <div>
            <p style={{ color: '#666', fontSize: '0.75rem', marginBottom: '0.25rem' }}>Gas Production</p>
            <p style={{ fontSize: '1.125rem', fontWeight: '600', color: '#2E7D32' }}>{sensorData.gasProduction.toFixed(0)} m¬≥</p>
          </div>
          <div>
            <p style={{ color: '#666', fontSize: '0.75rem', marginBottom: '0.25rem' }}>Feedstock</p>
            <p style={{ fontSize: '1.125rem', fontWeight: '600' }}>{sensorData.feedstockLevel.toFixed(0)}%</p>
          </div>
        </div>
      )}

      <button 
        onClick={onViewDetails}
        style={{ width: '100%', padding: '0.75rem', backgroundColor: '#2E7D32', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.5rem' }}
      >
        <Eye size={18} /> Lihat Detail
      </button>
    </div>
  );
}

// Listing Card Component
function ListingCard({ listing, onPurchase, isOwnListing }) {
  return (
    <div style={{ backgroundColor: 'white', padding: '1.5rem', borderRadius: '12px', boxShadow: '0 2px 8px rgba(0,0,0,0.1)' }}>
      <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1rem' }}>
        <div style={{ padding: '0.75rem', borderRadius: '8px', backgroundColor: listing.productType === 'biogas' ? '#E3F2FD' : '#E8F5E9' }}>
          {listing.productType === 'biogas' ? <Droplets size={24} color="#1976D2" /> : <Leaf size={24} color="#2E7D32" />}
        </div>
        <div>
          <h4 style={{ fontSize: '1.125rem', marginBottom: '0.25rem', textTransform: 'capitalize' }}>{listing.productType === 'biogas' ? 'Biogas' : 'Pupuk Organik'}</h4>
          <p style={{ color: '#666', fontSize: '0.875rem' }}>{listing.sellerName}</p>
        </div>
      </div>

      <p style={{ color: '#666', fontSize: '0.875rem', marginBottom: '1rem', lineHeight: '1.5' }}>{listing.description}</p>

      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem', padding: '1rem', backgroundColor: '#f5f5f5', borderRadius: '8px' }}>
        <div>
          <p style={{ color: '#666', fontSize: '0.75rem', marginBottom: '0.25rem' }}>Quantity</p>
          <p style={{ fontSize: '1rem', fontWeight: '600' }}>{listing.quantity} {listing.productType === 'biogas' ? 'm¬≥' : 'kg'}</p>
        </div>
        <div>
          <p style={{ color: '#666', fontSize: '0.75rem', marginBottom: '0.25rem' }}>Price</p>
          <p style={{ fontSize: '1rem', fontWeight: '600', color: '#2E7D32' }}>Rp {listing.pricePerUnit.toLocaleString()}</p>
        </div>
      </div>

      <p style={{ color: '#666', fontSize: '0.875rem', marginBottom: '1rem' }}>üìç {listing.sellerLocation}</p>

      {!isOwnListing ? (
        <button 
          onClick={onPurchase}
          style={{ width: '100%', padding: '0.75rem', backgroundColor: '#1976D2', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.5rem' }}
        >
          <ShoppingCart size={18} /> Beli Sekarang
        </button>
      ) : (
        <button 
          disabled
          style={{ width: '100%', padding: '0.75rem', backgroundColor: '#e0e0e0', color: '#666', border: 'none', borderRadius: '8px', cursor: 'not-allowed', fontWeight: '600' }}
        >
          Listing Anda
        </button>
      )}
    </div>
  );
}

// Add Bioreactor Modal
function AddBioreactorModal({ onClose, onAdd }) {
  const [formData, setFormData] = useState({ name: '', capacity: '', location: '' });

  const handleSubmit = (e) => {
    e.preventDefault();
    if (formData.name && formData.capacity && formData.location) {
      onAdd({ ...formData, capacity: parseInt(formData.capacity) });
    }
  };

  return (
    <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
      <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '12px', width: '90%', maxWidth: '500px' }}>
        <h3 style={{ fontSize: '1.5rem', marginBottom: '1.5rem' }}>Tambah Bioreaktor Baru</h3>
        <form onSubmit={handleSubmit}>
          <div style={{ marginBottom: '1rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', color: '#666' }}>Nama Bioreaktor</label>
            <input
              type="text"
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              style={{ width: '100%', padding: '0.75rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', boxSizing: 'border-box' }}
              required
            />
          </div>
          <div style={{ marginBottom: '1rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', color: '#666' }}>Kapasitas (m¬≥)</label>
            <input
              type="number"
              value={formData.capacity}
              onChange={(e) => setFormData({ ...formData, capacity: e.target.value })}
              style={{ width: '100%', padding: '0.75rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', boxSizing: 'border-box' }}
              required
            />
          </div>
          <div style={{ marginBottom: '1.5rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', color: '#666' }}>Lokasi</label>
            <input
              type="text"
              value={formData.location}
              onChange={(e) => setFormData({ ...formData, location: e.target.value })}
              style={{ width: '100%', padding: '0.75rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', boxSizing: 'border-box' }}
              required
            />
          </div>
          <div style={{ display: 'flex', gap: '1rem' }}>
            <button type="button" onClick={onClose} style={{ flex: 1, padding: '0.75rem', backgroundColor: '#e0e0e0', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600' }}>
              Batal
            </button>
            <button type="submit" style={{ flex: 1, padding: '0.75rem', backgroundColor: '#2E7D32', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600' }}>
              Tambah
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

// Add Listing Modal
function AddListingModal({ onClose, onAdd }) {
  const [formData, setFormData] = useState({ productType: 'biogas', quantity: '', pricePerUnit: '', description: '' });

  const handleSubmit = (e) => {
    e.preventDefault();
    if (formData.quantity && formData.pricePerUnit && formData.description) {
      onAdd({ 
        ...formData, 
        quantity: parseInt(formData.quantity),
        pricePerUnit: parseInt(formData.pricePerUnit)
      });
    }
  };

  return (
    <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
      <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '12px', width: '90%', maxWidth: '500px' }}>
        <h3 style={{ fontSize: '1.5rem', marginBottom: '1.5rem' }}>Tambah Listing Baru</h3>
        <form onSubmit={handleSubmit}>
          <div style={{ marginBottom: '1rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', color: '#666' }}>Tipe Produk</label>
            <select
              value={formData.productType}
              onChange={(e) => setFormData({ ...formData, productType: e.target.value })}
              style={{ width: '100%', padding: '0.75rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', boxSizing: 'border-box' }}
            >
              <option value="biogas">Biogas</option>
              <option value="fertilizer">Pupuk Organik</option>
            </select>
          </div>
          <div style={{ marginBottom: '1rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', color: '#666' }}>Quantity ({formData.productType === 'biogas' ? 'm¬≥' : 'kg'})</label>
            <input
              type="number"
              value={formData.quantity}
              onChange={(e) => setFormData({ ...formData, quantity: e.target.value })}
              style={{ width: '100%', padding: '0.75rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', boxSizing: 'border-box' }}
              required
            />
          </div>
          <div style={{ marginBottom: '1rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', color: '#666' }}>Harga per Unit (Rp)</label>
            <input
              type="number"
              value={formData.pricePerUnit}
              onChange={(e) => setFormData({ ...formData, pricePerUnit: e.target.value })}
              style={{ width: '100%', padding: '0.75rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', boxSizing: 'border-box' }}
              required
            />
          </div>
          <div style={{ marginBottom: '1.5rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', color: '#666' }}>Deskripsi</label>
            <textarea
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              style={{ width: '100%', padding: '0.75rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', minHeight: '80px', boxSizing: 'border-box' }}
              required
            />
          </div>
          <div style={{ display: 'flex', gap: '1rem' }}>
            <button type="button" onClick={onClose} style={{ flex: 1, padding: '0.75rem', backgroundColor: '#e0e0e0', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600' }}>
              Batal
            </button>
            <button type="submit" style={{ flex: 1, padding: '0.75rem', backgroundColor: '#1976D2', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600' }}>
              Tambah
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

// Bioreactor Detail Modal
function BioreactorDetailModal({ bioreactor, sensorData, onClose }) {
  return (
    <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
      <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '12px', width: '90%', maxWidth: '600px', maxHeight: '90vh', overflow: 'auto' }}>
        <h3 style={{ fontSize: '1.5rem', marginBottom: '1.5rem' }}>{bioreactor.name}</h3>
        
        <div style={{ display: 'grid', gap: '1.5rem' }}>
          <div>
            <h4 style={{ fontSize: '1.125rem', marginBottom: '1rem', color: '#666' }}>Informasi Bioreaktor</h4>
            <div style={{ display: 'grid', gap: '0.75rem' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span style={{ color: '#666' }}>Kapasitas:</span>
                <span style={{ fontWeight: '600' }}>{bioreactor.capacity} m¬≥</span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span style={{ color: '#666' }}>Status:</span>
                <span style={{ fontWeight: '600', color: bioreactor.status === 'active' ? '#2E7D32' : '#C62828', textTransform: 'capitalize' }}>{bioreactor.status}</span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span style={{ color: '#666' }}>Lokasi:</span>
                <span style={{ fontWeight: '600' }}>{bioreactor.location}</span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span style={{ color: '#666' }}>Tanggal Instalasi:</span>
                <span style={{ fontWeight: '600' }}>{new Date(bioreactor.installationDate).toLocaleDateString('id-ID')}</span>
              </div>
            </div>
          </div>

          {sensorData && (
            <div>
              <h4 style={{ fontSize: '1.125rem', marginBottom: '1rem', color: '#666' }}>Data Sensor Real-time</h4>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                <div style={{ padding: '1rem', backgroundColor: '#f5f5f5', borderRadius: '8px' }}>
                  <p style={{ color: '#666', fontSize: '0.875rem', marginBottom: '0.5rem' }}>Temperature</p>
                  <p style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#2E7D32' }}>{sensorData.temperature.toFixed(1)}¬∞C</p>
                </div>
                <div style={{ padding: '1rem', backgroundColor: '#f5f5f5', borderRadius: '8px' }}>
                  <p style={{ color: '#666', fontSize: '0.875rem', marginBottom: '0.5rem' }}>pH Level</p>
                  <p style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#1976D2' }}>{sensorData.phLevel.toFixed(2)}</p>
                </div>
                <div style={{ padding: '1rem', backgroundColor: '#f5f5f5', borderRadius: '8px' }}>
                  <p style={{ color: '#666', fontSize: '0.875rem', marginBottom: '0.5rem' }}>Gas Production</p>
                  <p style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#2E7D32' }}>{sensorData.gasProduction.toFixed(0)} m¬≥</p>
                </div>
                <div style={{ padding: '1rem', backgroundColor: '#f5f5f5', borderRadius: '8px' }}>
                  <p style={{ color: '#666', fontSize: '0.875rem', marginBottom: '0.5rem' }}>Pressure</p>
                  <p style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#F57C00' }}>{sensorData.pressure.toFixed(2)} bar</p>
                </div>
                <div style={{ padding: '1rem', backgroundColor: '#f5f5f5', borderRadius: '8px', gridColumn: '1 / -1' }}>
                  <p style={{ color: '#666', fontSize: '0.875rem', marginBottom: '0.5rem' }}>Feedstock Level</p>
                  <div style={{ width: '100%', height: '8px', backgroundColor: '#e0e0e0', borderRadius: '4px', marginTop: '0.5rem', overflow: 'hidden' }}>
                    <div style={{ width: `${sensorData.feedstockLevel}%`, height: '100%', backgroundColor: '#2E7D32', borderRadius: '4px', transition: 'width 0.3s' }}></div>
                  </div>
                  <p style={{ fontSize: '1.125rem', fontWeight: 'bold', marginTop: '0.5rem' }}>{sensorData.feedstockLevel.toFixed(0)}%</p>
                </div>
              </div>
            </div>
          )}
        </div>

        <button 
          onClick={onClose}
          style={{ width: '100%', padding: '0.75rem', backgroundColor: '#2E7D32', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', marginTop: '1.5rem' }}
        >
          Tutup
        </button>
      </div>
    </div>
  );
}